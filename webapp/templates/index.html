<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARM Template Generator</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='azure_arm.png') }}">

    <!-- Tailwind CSS for General Styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- PrismJS for Syntax Highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bicep.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen py-8">
    <div class="container mx-auto max-w-4xl px-4">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800 text-center">ARM Template Generator</h1>
            <p class="text-gray-600 text-center mt-2">Generate Bicep templates from natural language</p>
        </header>

        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-6">
            <div class="flex items-center justify-between cursor-pointer" onclick="toggleVisualizations()">
                <h2 class="text-lg font-semibold text-purple-900">Model Training & Data Visualizations</h2>
                <svg id="visualizations-arrow" class="w-5 h-5 text-purple-900 transition-transform rotate-[-90deg]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>
            <div id="visualizations-content" class="mt-4" style="display: none;">
                <p class="text-sm text-gray-700 mb-6">This application combines fine-tuned AI models with Retrieval-Augmented Generation (RAG) to produce accurate, context-aware Bicep templates. Below are visualizations showing the training performance and data composition that power this system.</p>

                <div class="mb-6 p-4 bg-white rounded-lg border border-purple-200">
                    <h3 class="text-md font-semibold text-gray-800 mb-3">System Architecture</h3>
                    <div class="mb-3">
                        <p class="text-sm text-gray-700 mb-2"><strong>What this shows:</strong> The complete end-to-end architecture of the Bicep template generation system.</p>
                        <p class="text-sm text-gray-700 mb-2"><strong>Key Components:</strong> Users access the Azure Container Application via the public internet. That application uses a Managed Identity to authenticate with Azure services through VNet integration with the virtual network that contains all of the back-end resources. A Network Security Group controls inbound and outbound traffic to the application. The application first retrieves user prompts and context from Azure AI Search via a private endpoint, then sends this information to the fine-tuned GPT-4.1-mini agent for processing, also via private endpoint. Private DNS Zones provide DNS resolution for each of the private endpoints. Azure AI Search uses a Managed Identity to authenticate with the Azure Blob Storage account that contains the grounding data. Azure AI Foundry uses a Managed Identity to authenticate with the Azure Blob Storage account that contains the training data.</p>
                    </div>
                    <div class="flex justify-center p-4 bg-gray-50 rounded">
                        <img src="{{ url_for('static', filename='architecture-diagram.png') }}"
                             alt="System Architecture Diagram"
                             loading="lazy"
                             class="max-w-full h-auto cursor-pointer hover:opacity-80 transition-opacity"
                             style="max-height: 500px;"
                             onclick="openImageModal(this)"
                             title="Click to enlarge">
                    </div>
                </div>

                <div class="mb-6 p-4 bg-white rounded-lg border border-purple-200">
                    <h3 class="text-md font-semibold text-gray-800 mb-3">Request Flow Diagram</h3>
                    <div class="mb-3">
                        <p class="text-sm text-gray-700 mb-2"><strong>What this shows:</strong> The complete end-to-end request flow of the Bicep template generation application, from user input to final code delivery.</p>
                        <p class="text-sm text-gray-700 mb-2"><strong>How it works:</strong> When you submit a prompt, the system performs hybrid search across Azure AI Search to retrieve relevant context (AVM modules or ARM schemas based on your mode selection). This context is combined with your prompt and sent to the fine-tuned GPT-4.1-mini agent, which generates structured JSON containing the plan, Bicep code, parameters, and warnings. The backend extracts the code and returns it back to your browser in real-time.</p>
                        <p class="text-sm text-gray-700"><strong>Key components:</strong> Flask web app, Azure AI Search (semantic + vector search), fine-tuned Azure OpenAI agent, and a comprehensive knowledge base of 20,000+ documents.</p>
                    </div>
                    <div class="flex justify-center p-4 bg-gray-50 rounded">
                        <img src="{{ url_for('static', filename='request-flow.png') }}"
                             alt="Request Flow Diagram"
                             loading="lazy"
                             class="max-w-full h-auto cursor-pointer hover:opacity-80 transition-opacity"
                             style="max-height: 500px;"
                             onclick="openImageModal(this)"
                             title="Click to enlarge">
                    </div>
                </div>

                <div class="mb-6 p-4 bg-white rounded-lg border border-purple-200">
                    <h3 class="text-md font-semibold text-gray-800 mb-3">RAG Data Source Composition</h3>
                    <div class="mb-3">
                        <p class="text-sm text-gray-700 mb-2"><strong>What this shows:</strong> The distribution of documentation in our Azure AI Search index that provides context to the AI agent during generation.</p>
                        <p class="text-sm text-gray-700 mb-2"><strong>Why it matters:</strong> The index contains over 20,000 documents combining classic ARM resource schemas (93.6%) with Azure Verified Module (AVM) documentation (6.4%). This comprehensive knowledge base allows the agent to generate both traditional Bicep resources and modern AVM-based templates.</p>
                        <p class="text-sm text-gray-700"><strong>Impact:</strong> The large schema collection ensures broad resource coverage, while AVM modules provide best-practice implementations for common scenarios.</p>
                    </div>
                    <div class="flex justify-center p-4">
                        <img src="{{ url_for('static', filename='rag_data_composition.png') }}"
                             loading="lazy"
                             alt="RAG Data Composition"
                             class="max-w-full h-auto cursor-pointer hover:opacity-80 transition-opacity"
                             style="max-height: 400px;"
                             onclick="openImageModal(this)"
                             title="Click to enlarge">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 bg-white rounded-lg border border-purple-200">
                        <h3 class="text-md font-semibold text-gray-800 mb-3">Training Loss</h3>
                        <div class="mb-3">
                            <p class="text-xs text-gray-700 mb-2"><strong>What this shows:</strong> How the model's prediction errors decreased over 157 training steps.</p>
                            <p class="text-xs text-gray-700 mb-2"><strong>Why it matters:</strong> The steep initial drop and continued decline demonstrate that the model successfully learned to generate structured JSON outputs with valid Bicep code, plans, and warnings.</p>
                            <p class="text-xs text-gray-700"><strong>Result:</strong> Final training loss of 0.03 indicates high-quality, consistent outputs.</p>
                        </div>
                        <div class="flex justify-center p-3 bg-gray-50 rounded">
                            <img src="{{ url_for('static', filename='training-loss-graph.png') }}"
                                 loading="lazy"
                                 alt="Training Loss Graph"
                                 class="max-w-full h-auto cursor-pointer hover:opacity-80 transition-opacity"
                                 onclick="openImageModal(this)"
                                 title="Click to enlarge">
                        </div>
                    </div>

                    <div class="p-4 bg-white rounded-lg border border-purple-200">
                        <h3 class="text-md font-semibold text-gray-800 mb-3">Training Accuracy</h3>
                        <div class="mb-3">
                            <p class="text-xs text-gray-700 mb-2"><strong>What this shows:</strong> The percentage of training examples where the model produced correct, properly-formatted responses.</p>
                            <p class="text-xs text-gray-700 mb-2"><strong>Why it matters:</strong> The rapid climb to 100% accuracy shows the model mastered the task of generating valid JSON with correct Bicep syntax, proper parameter handling, and contextually appropriate warnings.</p>
                            <p class="text-xs text-gray-700"><strong>Result:</strong> Perfect accuracy on training data, with strong generalization to new prompts.</p>
                        </div>
                        <div class="flex justify-center p-3 bg-gray-50 rounded">
                            <img src="{{ url_for('static', filename='training-accuracy-graph.png') }}"
                                 loading="lazy"
                                 alt="Training Accuracy Graph"
                                 class="max-w-full h-auto cursor-pointer hover:opacity-80 transition-opacity"
                                 onclick="openImageModal(this)"
                                 title="Click to enlarge">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <div class="flex items-center justify-between cursor-pointer" onclick="toggleInstructions()">
                <h2 class="text-lg font-semibold text-blue-900">üìñ How to Write Effective Prompts</h2>
                <svg id="instructions-arrow" class="w-5 h-5 text-blue-900 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>
            <div id="instructions-content" class="mt-4">
                <p class="text-sm text-gray-700 mb-3">For best results, include these details in your prompt:</p>
                <ul class="text-sm text-gray-700 space-y-2 list-disc list-inside">
                    <li><strong>Resource Type:</strong> Specify the Azure resource (e.g., Storage Account, Virtual Machine, App Service)</li>
                    <li><strong>Configuration:</strong> Include key settings (e.g., SKU, tier, redundancy type)</li>
                    <li><strong>Location:</strong> Mention the Azure region if specific (e.g., East US, West Europe)</li>
                    <li><strong>Dependencies:</strong> Note any related resources or connections needed</li>
                    <li><strong>Security:</strong> Specify access controls, encryption, or network requirements</li>
                </ul>
                <div class="mt-4 p-3 bg-white rounded border border-blue-200">
                    <p class="text-xs font-semibold text-gray-700 mb-2">Example prompts:</p>
                    <div class="space-y-2">
                        <div class="flex items-start gap-2">
                            <span class="text-xs text-gray-600 flex-1">‚Ä¢ "Create a storage account with blob storage, geo-redundant storage, and HTTPS-only access in East US"</span>
                            <button onclick="useExample('Create a storage account with blob storage, geo-redundant storage, and HTTPS-only access in East US')"
                                    class="px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors whitespace-nowrap">
                                Use This
                            </button>
                        </div>
                        <div class="flex items-start gap-2">
                            <span class="text-xs text-gray-600 flex-1">‚Ä¢ "Deploy an App Service with B1 tier, .NET 8 runtime, and integrate with Application Insights"</span>
                            <button onclick="useExample('Deploy an App Service with B1 tier, .NET 8 runtime, and integrate with Application Insights')"
                                    class="px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors whitespace-nowrap">
                                Use This
                            </button>
                        </div>
                        <div class="flex items-start gap-2">
                            <span class="text-xs text-gray-600 flex-1">‚Ä¢ "Create a Key Vault with soft delete enabled and RBAC authorization"</span>
                            <button onclick="useExample('Create a Key Vault with soft delete enabled and RBAC authorization')"
                                    class="px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors whitespace-nowrap">
                                Use This
                            </button>
                        </div>
                        <div class="flex items-start gap-2">
                            <span class="text-xs text-gray-600 flex-1">‚Ä¢ "Deploy a virtual network with three subnets for web, app, and database tiers"</span>
                            <button onclick="useExample('Deploy a virtual network with three subnets for web, app, and database tiers')"
                                    class="px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors whitespace-nowrap">
                                Use This
                            </button>
                        </div>
                        <div class="flex items-start gap-2">
                            <span class="text-xs text-gray-600 flex-1">‚Ä¢ "Create a Linux VM with SSH authentication and managed identity enabled"</span>
                            <button onclick="useExample('Create a Linux VM with SSH authentication and managed identity enabled')"
                                    class="px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors whitespace-nowrap">
                                Use This
                            </button>
                        </div>
                        <div class="flex items-start gap-2">
                            <span class="text-xs text-gray-600 flex-1">‚Ä¢ "Set up a container registry with admin access disabled and geo-replication"</span>
                            <button onclick="useExample('Set up a container registry with admin access disabled and geo-replication')"
                                    class="px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors whitespace-nowrap">
                                Use This
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <label class="block text-sm font-medium text-gray-700 mb-3">
                    Bicep Generation Mode:
                </label>
                <div class="flex items-center gap-6">
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="bicep-mode" value="avm" id="mode-avm" checked class="w-4 h-4 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">
                            <strong>Use Azure Verified Modules (AVM)</strong>
                            <span class="block text-xs text-gray-500 mt-1">Recommended - Uses official, maintained modules <u>if available</u></span>
                        </span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="bicep-mode" value="classic" id="mode-classic" class="w-4 h-4 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">
                            <strong>Classic Bicep</strong>
                            <span class="block text-xs text-gray-500 mt-1">Generate raw resource definitions</span>
                        </span>
                    </label>
                </div>
            </div>

            <div class="mb-6">
                <label for="prompt-input" class="block text-sm font-medium text-gray-700 mb-2">
                    Enter your prompt:
                </label>
                <textarea
                    id="prompt-input"
                    rows="4"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Example: Create a storage account with blob storage in East US..."
                ></textarea>
            </div>

            <div class="mb-6">
                <button
                    id="submit-button"
                    class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition"
                >
                    Generate Template
                </button>
            </div>

            <p id="status-message" class="text-sm text-gray-600 mb-4"></p>

            <div class="mb-4">
                <div class="flex items-center justify-between mb-2">
                    <label class="block text-sm font-medium text-gray-700">
                        Generated Bicep Code:
                    </label>
                    <div class="flex gap-2">
                        <button
                            id="wrap-toggle"
                            onclick="toggleWordWrap()"
                            class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded transition"
                            title="Toggle word wrap"
                        >
                            Wrap: On
                        </button>
                        <button
                            id="copy-button"
                            onclick="copyCode()"
                            class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded transition"
                            title="Copy to clipboard"
                        >
                            üìã Copy
                        </button>
                        <button
                            id="download-button"
                            onclick="downloadCode()"
                            class="text-xs bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded transition"
                            title="Download as .bicep file"
                        >
                            üíæ Download
                        </button>
                    </div>
                </div>
                <div class="bg-gray-900 rounded-md overflow-x-auto">
                    <pre id="code-pre" class="m-0 p-4" style="white-space: pre; tab-size: 4;"><code id="output-code" class="language-bicep" style="white-space: pre; tab-size: 4;">// Generated code will appear here...</code></pre>
                </div>
            </div>

            <!-- Debug Information Section -->
            <div class="mt-4 bg-gray-50 border border-gray-200 rounded-lg p-4">
                <div class="flex items-center justify-between cursor-pointer" onclick="toggleDebug()">
                    <h3 class="text-sm font-semibold text-gray-800">üîç Debug Information</h3>
                    <svg id="debug-arrow" class="w-4 h-4 text-gray-700 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
                <div id="debug-content" class="mt-3 space-y-3 hidden">
                    <div class="grid grid-cols-3 gap-4">
                        <div class="bg-white p-3 rounded border border-gray-200">
                            <p class="text-xs font-semibold text-gray-600 mb-1">Total Time</p>
                            <p id="debug-total-time" class="text-sm text-gray-800">-</p>
                        </div>
                        <div class="bg-white p-3 rounded border border-gray-200">
                            <p class="text-xs font-semibold text-gray-600 mb-1">Search Time</p>
                            <p id="debug-search-time" class="text-sm text-gray-800">-</p>
                        </div>
                        <div class="bg-white p-3 rounded border border-gray-200">
                            <p class="text-xs font-semibold text-gray-600 mb-1">AI Generation Time</p>
                            <p id="debug-ai-time" class="text-sm text-gray-800">-</p>
                        </div>
                    </div>
                    <div class="bg-white p-3 rounded border border-gray-200">
                        <div class="flex items-center justify-between mb-2">
                            <p class="text-xs font-semibold text-gray-600">Search Results</p>
                            <button
                                id="toggle-search-content-btn"
                                onclick="toggleSearchContent()"
                                class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded transition"
                                title="Toggle search content visibility"
                            >
                                Show Content
                            </button>
                        </div>
                        <p id="debug-search-results" class="text-sm text-gray-800 mb-2">-</p>
                        <div id="search-content-container" class="hidden mt-2">
                            <div class="bg-gray-900 rounded-md overflow-x-auto max-h-96 overflow-y-auto">
                                <pre class="m-0 p-3 text-xs whitespace-pre"><code id="search-content-code" class="text-gray-300" style="tab-size: 4;">No search content available</code></pre>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-3 rounded border border-gray-200">
                        <p class="text-xs font-semibold text-gray-600 mb-1">Context Size</p>
                        <p id="debug-context-size" class="text-sm text-gray-800">-</p>
                    </div>
                    <div class="bg-white p-3 rounded border border-gray-200">
                        <p class="text-xs font-semibold text-gray-600 mb-1">Request Mode</p>
                        <p id="debug-mode" class="text-sm text-gray-800">-</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Prism syntax highlighting
        Prism.highlightAll();
    </script>

    <script src="{{ url_for('static', filename='index.js') }}"></script>

    <!-- Image Modal for enlarged view -->
    <div id="image-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75 p-4" onclick="closeImageModal()">
        <div class="relative max-w-7xl max-h-full">
            <button onclick="closeImageModal()" class="absolute -top-10 right-0 text-white hover:text-gray-300 text-3xl font-bold">&times;</button>
            <img id="modal-image" src="" alt="" class="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl">
        </div>
    </div>

    <footer class="mt-8 text-center text-sm text-gray-500">
        <p>Azure Bicep Template Generator v{{ version }}</p>
        <p class="mt-1">Powered by Azure AI Foundry & Azure AI Search</p>
    </footer>
</body>
</html>
